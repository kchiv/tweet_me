{% extends 'base.html' %}

{% block title %}All Tweets {{ block.super }}{% endblock title %}

{% block script %}

<script>

const urlParams = new URLSearchParams(window.location.search);
	
$(document).ready(function(){

	const myParam = urlParams.get('q');
	var tweetList = [];

	function attachTweet(tweetValue, prepend){
		var dateDisplay = tweetValue.date_display;
		var tweetContent = tweetValue.content;
		var tweetUser = tweetValue.user;
		var tweetFormattedHtml = "<div class=\"row\"><div class=\"col-sm-3 col-xs-12\"><h1>" + tweetUser.username + "</h1></div><div class=\"col-sm-9\"><p>" + tweetContent + "</p><p>via " + tweetUser.username + " | " + dateDisplay + " | " + "<a href='#'>View</a></p>" + "</div><div class=\"col-sm-12\"><hr></div>";
		if (prepend==true){
			$("#tweet-container").prepend(tweetFormattedHtml)
		} else {
			$("#tweet-container").append(tweetFormattedHtml)
		}
	}

	function parseTweets(){
		if (tweetList == 0){
			$("#tweet-container").text("No tweets currently found.")
		} else {
		// tweets exist, parse and them
		$.each(tweetList, function(key, value){
			var tweetKey = key;
			attachTweet(value)
		})
		}
	};

	function fetchTweets(){
		console.log("fetching...")
		$.ajax({
			url: "/api/tweet/",
			data: {
				"q": myParam
			},
			method: "GET",
			success: function(data){
				tweetList = data
				parseTweets()
			},
			error: function(data){
				console.log("error")
				console.log(data)
			}
		})
	}

	fetchTweets()

	var charsStart = 140;
	var charsCurrent = 0;

	$("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>")

	$("#tweet-form textarea").keyup(function(event){
		var tweetValue = $(this).val()
		charsCurrent = charsStart - tweetValue.length
		var spanChars = $("#tweetCharsLeft")
		spanChars.text(charsCurrent)

		if (charsCurrent > 0) {
			// remove class
			spanChars.removeClass("grey-color")
			spanChars.removeClass("red-color")
		} else if (charsCurrent == 0) {
			// add gray class
			spanChars.addClass("grey-color")
			spanChars.removeClass("red-color")
		} else if (charsCurrent < 0) {
			// add red class
			spanChars.addClass("red-color")
			spanChars.removeClass("grey-color")
		}
	})

	$("#tweet-form").submit(function(event){
		event.preventDefault()

		var this_ = $(this)
		var formData = this_.serialize()
		if (charsCurrent >= 0) {
			$.ajax({
				url: "/api/tweet/create/",
				data: formData,
				method: "POST",
				success: function(data){
					//console.log(data)
					this_.find("input[type=text], textarea").val("")
					attachTweet(data, true)
				},
				error: function(data){
					console.log("error")
					console.log(data)
				}
			})
		} else {
			console.log("Cannot send. Tweet too long.")
		}
	})

});

</script>

{% endblock script %}

{% block content %}

	{% if not request.GET.q %}
		<div class="row">
			<div class="col-sm-9 offset-sm-3">
				{% include 'tweets/form.html' with form=create_form action_url=create_url btn_title='Tweet' form_id='tweet-form' %}
			</div>
		</div>
		<hr>
	{% endif %}

	<div id="tweet-container">
		
	</div>

{% endblock content %}